From 7b6630ebdc8ef29940af677aff7fbe75be1c965a Mon Sep 17 00:00:00 2001
From: Andreas Beckmann <anbe@debian.org>
Date: Sun, 8 Dec 2024 22:54:59 +0100
Subject: [PATCH] backport uvm warning fixes from 560.28.03

---
 nvidia-uvm/uvm_kepler_mmu.c          | 1 +
 nvidia-uvm/uvm_page_tree_test.c      | 2 +-
 nvidia-uvm/uvm_pascal_fault_buffer.c | 7 -------
 nvidia-uvm/uvm_pascal_mmu.c          | 1 +
 nvidia-uvm/uvm_tools.c               | 1 +
 5 files changed, 4 insertions(+), 8 deletions(-)

diff --git a/nvidia-uvm/uvm_kepler_mmu.c b/nvidia-uvm/uvm_kepler_mmu.c
index 96305685..b7d1b27c 100644
--- a/nvidia-uvm/uvm_kepler_mmu.c
+++ b/nvidia-uvm/uvm_kepler_mmu.c
@@ -38,6 +38,7 @@
 #include "uvm_forward_decl.h"
 #include "uvm_gpu.h"
 #include "uvm_mmu.h"
+#include "uvm_hal.h"
 #include "uvm_push_macros.h"
 #include "hwref/kepler/gk104/dev_mmu.h"
 
diff --git a/nvidia-uvm/uvm_page_tree_test.c b/nvidia-uvm/uvm_page_tree_test.c
index 60f7d614..d2b3f272 100644
--- a/nvidia-uvm/uvm_page_tree_test.c
+++ b/nvidia-uvm/uvm_page_tree_test.c
@@ -1450,7 +1450,7 @@ static uvm_mmu_page_table_alloc_t fake_table_alloc(uvm_aperture_t aperture, NvU6
 // Queries the supported page sizes of the GPU(uvm_gpu_t) and fills the
 // page_sizes array up to MAX_NUM_PAGE_SIZE. Returns the number of elements in
 // page_sizes;
-size_t get_page_sizes(uvm_gpu_t *gpu, NvU32 *page_sizes)
+static size_t get_page_sizes(uvm_gpu_t *gpu, NvU32 *page_sizes)
 {
     unsigned long page_size_log2;
     unsigned long page_sizes_bitvec;
diff --git a/nvidia-uvm/uvm_pascal_fault_buffer.c b/nvidia-uvm/uvm_pascal_fault_buffer.c
index 2186d293..6c313cad 100644
--- a/nvidia-uvm/uvm_pascal_fault_buffer.c
+++ b/nvidia-uvm/uvm_pascal_fault_buffer.c
@@ -292,10 +292,3 @@ NvU32 uvm_hal_pascal_fault_buffer_entry_size(uvm_parent_gpu_t *parent_gpu)
 {
     return NVB069_FAULT_BUF_SIZE;
 }
-
-void uvm_hal_pascal_fault_buffer_parse_non_replayable_entry_unsupported(uvm_parent_gpu_t *parent_gpu,
-                                                                        void *fault_packet,
-                                                                        uvm_fault_buffer_entry_t *buffer_entry)
-{
-    UVM_ASSERT_MSG(false, "fault_buffer_parse_non_replayable_entry called on Pascal GPU\n");
-}
diff --git a/nvidia-uvm/uvm_pascal_mmu.c b/nvidia-uvm/uvm_pascal_mmu.c
index 8b17319e..46724e23 100644
--- a/nvidia-uvm/uvm_pascal_mmu.c
+++ b/nvidia-uvm/uvm_pascal_mmu.c
@@ -36,6 +36,7 @@
 #include "uvm_global.h"
 #include "uvm_gpu.h"
 #include "uvm_mmu.h"
+#include "uvm_hal.h"
 #include "uvm_push_macros.h"
 #include "uvm_pascal_fault_buffer.h"
 #include "hwref/pascal/gp100/dev_fault.h"
diff --git a/nvidia-uvm/uvm_tools.c b/nvidia-uvm/uvm_tools.c
index f0aceaf9..dfb9f2c1 100644
--- a/nvidia-uvm/uvm_tools.c
+++ b/nvidia-uvm/uvm_tools.c
@@ -25,6 +25,7 @@
 #include "uvm_gpu.h"
 #include "uvm_hal.h"
 #include "uvm_tools.h"
+#include "uvm_tools_init.h"
 #include "uvm_va_space.h"
 #include "uvm_api.h"
 #include "uvm_hal_types.h"
-- 
2.39.5

